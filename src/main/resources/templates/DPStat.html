<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="../static/jquery-1.11.3.min.js"></script>
    <script th:inline="javascript">
    /*<![CDATA[*/

        // Load the Visualization API and the piechart package.
        google.load('visualization', '1.0', {'packages':['corechart']});

        // Set a callback to run when the Google Visualization API is loaded.
        google.setOnLoadCallback(drawCharts);

        function drawCharts() {
            var dpname = encodeURIComponent([[${DPname}]]);
            var basecharts = "http://localhost:8080/DataTable/DPStats/";
            var baselist = "http://localhost:8080/JSON/DPStats/Identities/";
            drawChart(basecharts + "Top/runner/faction/" + dpname, 'Top runner factions', 'chart_div1');
            drawChart(basecharts + "Top/corp/faction/" + dpname, 'Top corp factions', 'chart_div2');
            drawChart(basecharts + "Top/runner/identity/" + dpname, 'Top runner identities', 'chart_div3');
            drawChart(basecharts + "Top/corp/identity/" + dpname, 'Top corp identities', 'chart_div4');
            listIdentities(baselist + "runner/" + dpname, "#text_div1");
            listIdentities(baselist + "corp/"+ dpname, "#text_div2");
        }

        // Callback that creates and populates a data table,
        // instantiates the pie chart, passes in the data and
        // draws it.
        function drawChart(urlvalue, title, elementid) {

            var slices = new Array;

            var jsonData = $.ajax({
                url: urlvalue,
                dataType: "json",
                async: false,
                success: function(data) {
                    $.each(data.rows, function (index, element) {
                        console.log(element.c[2].v);
                        slices.push({color : element.c[2].v});
                    });
                }
            }).responseText;

            // Create our data table out of JSON data loaded from server.
            var data = new google.visualization.DataTable(jsonData);

            // Set chart options
            var options = {'title': title,
                       'width':400,
                       'height':300,
                        'slices': slices};

            // Instantiate and draw our chart, passing in some options.
            var chart = new google.visualization.PieChart(document.getElementById(elementid));
            chart.draw(data, options);
        }

      function listIdentities(urlvalue, elementid) {
          var jsonData = $.ajax({
              url: urlvalue,
              dataType: "json",
              async: false,
              success: function(data) {
                  $.each(data.identities, function(index, element) {
                      $(elementid).append($('<div>', {
                          text: element.title
                      }));
                  });
              }
          });
      }
    /*]]>*/
    </script>
</head>

<body>
<p th:text="${DPname}"></p>
<!--Div that will hold the pie chart-->
<table>
    <tr>
        <td><div id="chart_div1"></div></td>
        <td><div id="chart_div2"></div></td>
    </tr>
    <tr>
        <td><div id="chart_div3"></div></td>
        <td><div id="chart_div4"></div></td>
    </tr>
    <tr>
        <td><div id="text_div1"></div></td>
        <td><div id="text_div2"></div></td>
    </tr>
</table>
</body>
</html>