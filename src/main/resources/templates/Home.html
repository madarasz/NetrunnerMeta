<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head">
</head>
<body>
    <div th:replace="fragments/navbar :: navbar"></div>
    <div class="container">
        <h3 class="page-header">Statistics on tournament cardpools</h3>

        <div class="row top-buffer">
            <div class="col-md-8 col-xs-12">
                <div class="col-xs-12">
                    <h4>
                        Runner factions over time
                        <div class="btn-group btn-group-xs" role="group" aria-label="runner data">
                            <button id="runnertop" type="button" class="btn btn-default active">Top 30%</button>
                            <button id="runnerall" type="button" class="btn btn-default">All</button>
                            <button id="runnerboth" type="button" class="btn btn-default">Both</button>
                        </div>
                        <ktm:tooltip place="right" text="The charts show the popularity of factions over time.
                        Time is represented by tournament legal cardpool."/>
                    </h4>
                    <div id="chart_div1" class="chart-responsive spinner"></div>
                </div>
                <div class="col-xs-12">
                    <h4>
                        Corp factions over time
                        <div class="btn-group btn-group-xs" role="group" aria-label="runner data">
                            <button id="corptop" type="button" class="btn btn-default active">Top 30%</button>
                            <button id="corpall" type="button" class="btn btn-default">All</button>
                            <button id="corpboth" type="button" class="btn btn-default">Both</button>
                        </div>
                        <ktm:tooltip place="right" text="The charts show the popularity of factions over time.
                        Time is represented by tournament legal cardpool."/>
                    </h4>
                    <div id="chart_div2" class="chart-responsive spinner"></div>
                </div>
            </div>
            <div class="col-md-4 col-xs-12">
                <div class="col-xs-12">
                    <h4>
                        Tournament Drilldown
                        <ktm:tooltip place="top" text="Click on an expansion name for more information on tournaments with that cardpool."/>
                    </h4>
                    <div class="list-group">
                        <a href="/DPStats/Last%203%20aggregated" class="list-group-item list-group-item-info"><em>last 3 aggregated</em></a>
                        <a th:each="cardpool : ${cardpools}" th:text="${cardpool}" th:href="@{/DPStats/__${cardpool}__/}" class="list-group-item"></a>
                    </div>
                </div>
                <div class="col-xs-12">
                    <div class="panel panel-default top-buffer" id="infopanel">
                        <div class="panel-heading">Welcome</div>
                        <div class="panel-body text-justify">
                            <p>
                                Welcome to <strong>Know the Meta</strong>. This site provides statistical information
                                on the cardgame <strong>Android: Netrunner</strong>.
                            </p>
                            <p>
                                <strong>Know the Meta</strong> has data on what kind of factions, identities, decks
                                and cards are being played at tournaments.
                            </p>
                            <p>
                                Keep posting your tournament decklists to <strong>Acoo.net</strong> or <strong>Stimhack</strong>,
                                so <strong>Know the Meta</strong> can provide the information you seek.
                                <div class="row">
                                    <div class="col-md-6 text-center">
                                        <a href="http://www.acoo.net/" target="_blank" rel="nofollow">
                                            <img th:src="@{/static/img/acoo-logo.png}"/>
                                        </a>
                                    </div>
                                    <div class="col-md-6 text-center">
                                        <a href="http://stimhack.com/tournament-decklists/" target="_blank" rel="nofollow">
                                            <img th:src="@{/static/img/stimhack-logo.png}"/>
                                        </a>
                                     </div>
                                </div>
                            </p>
                        </div>
                    </div>
                    <p class="text-center">
                        <small>last update: <span th:text="${lastUpdate}"></span></small>
                    </p>
                </div>
            </div>
        </div>
        <h3 class="page-header">Latest blog entries <a href="/RSS/blog"><i class="fa fa-rss-square"></i></a></h3>
        <div class="row">
            <div class="col-md-8 col-xs-12">
                <div class="row">
                    <div class="col-xs-12" th:each="blog : ${blogs}">
                        <div class="row">
                            <div class="col-md-3 teaser-col">
                                <a th:href="@{/Blog/__${blog.url}__}"><img th:src="${blog.imageUri}" th:alt="${blog.title}"/></a>
                            </div>
                            <div class="col-md-9 teaser-col">
                                <h5>
                                    <a th:href="@{/Blog/__${blog.url}__}" th:text="${blog.title}"></a><br/>
                                    <small><span th:text="${blog.formattedDate}"></span> - <span th:text="${blog.pack}"></span></small>
                                </h5>
                                <div th:utext="${blog.teaser}" class="text-justify"></div>
                                <a th:href="@{/Blog/__${blog.url}__}">Read more</a>
                            </div>
                        </div>
                        <hr />
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-xs-12">
                <div th:replace="fragments/social :: social"></div>
                <div th:replace="fragments/googlead :: blog"></div>
            </div>
        </div>

        <div th:replace="fragments/footer :: footer"></div>
    </div>
    <div th:replace="fragments/head :: scripts"></div>

    <script type="text/javascript"
            src="https://www.google.com/jsapi?autoload={
            'modules':[{
              'name':'visualization',
              'version':'1',
              'packages':['corechart']
            }]
          }"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/

        $('.btn-group-xs button').attr('disabled','disabled');

        google.setOnLoadCallback(loadFactionData);
        
        var runnerData = [['DP', 'shaper top', 'shaper all', 'anarch top', 'anarch all', 'criminal top', 'criminal all',
                'adam top', 'adam all', 'apex top', 'apex all', 'sunny-lebeau top', 'sunny-lebeau all']],
            corpData = [['DP', 'jinteki top', 'jinteki all', 'nbn top', 'nbn all', 'haas-bioroid top', 'haas-bioroid all',
                'weyland-consortium top', 'weyland-consortium all']],
            runnerOption = 'top', corpOption = 'top';

        $(window).resize(function(){
            drawFactionChart(runnerData, runnerFactions, "chart_div1", runnerOption);
            drawFactionChart(corpData, corpFactions, "chart_div2", corpOption);
        });

        // button triggers
        $('#runnertop').click(function() {
            runnerOption = 'top';
            drawFactionChart(runnerData, runnerFactions, "chart_div1", runnerOption);
        });
        $('#runnerall').click(function() {
            $('#runnertop').removeClass('active');
            runnerOption = 'all';
            drawFactionChart(runnerData, runnerFactions, "chart_div1", runnerOption);
        });
        $('#runnerboth').click(function() {
            $('#runnertop').removeClass('active');
            runnerOption = 'both';
            drawFactionChart(runnerData, runnerFactions, "chart_div1", runnerOption);
        });
        $('#corptop').click(function() {
            corpOption = 'top';
            drawFactionChart(corpData, corpFactions, "chart_div2", corpOption);
        });
        $('#corpall').click(function() {
            $('#corptop').removeClass('active');
            corpOption = 'all';
            drawFactionChart(corpData, corpFactions, "chart_div2", corpOption);
        });
        $('#corpboth').click(function() {
            $('#corptop').removeClass('active');
            corpOption = 'both';
            drawFactionChart(corpData, corpFactions, "chart_div2", corpOption);
        });

        function loadFactionData() {
            $.ajax({
                url: '/JSON/FactionsOverTime',
                dataType: "json",
                async: true,
                success: function(data) {
                    $.each(data, function (index, element) {
                        runnerData.push([]);
                        corpData.push([]);
                        runnerData[runnerData.length - 1].push(element.packTitle);
                        corpData[corpData.length - 1].push(element.packTitle);
                        populateFOTData(runnerFactions, element.runners,
                                element.runnerTopStandingCount, element.runnerAllStandingCount, runnerData);
                        populateFOTData(corpFactions, element.corps,
                                element.corpTopStandingCount, element.corpAllStandingCount, corpData);
                    });
                    runnerData = new google.visualization.arrayToDataTable(runnerData);
                    corpData = new google.visualization.arrayToDataTable(corpData);
                    drawFactionChart(runnerData, runnerFactions, "chart_div1", runnerOption);
                    drawFactionChart(corpData, corpFactions, "chart_div2", corpOption);
                    $('.btn-group-xs button').removeAttr('disabled');
                    // social
                    facebookButton(document, 'script', 'facebook-jssdk');
                    twitterTimeline(document,"script", "twitter-wjs");
                }
            });
        }

        function populateFOTData(factions, factionData, topStanding, allStanding, dataArray) {
            $.each(factions, function (index, faction) {
                var datarow = readFaction(factionData, faction);
                if (datarow === undefined) {
                    dataArray[dataArray.length - 1].push(0, 0);
                } else {
                    var top = datarow.topStandingCount / topStanding,
                            all = datarow.allStandingCount / allStanding;
                    dataArray[dataArray.length - 1].push({f: Math.round(top*1000)/10+'%',v: top});
                    dataArray[dataArray.length - 1].push({f: Math.round(all*1000)/10+'%',v: all});
                }
            });
        }

        function readFaction(data, faction) {
            var result;
            $.each(data, function (index, element) {
               if (element.faction === faction) {
                   result = element;
                   return false;
               }
            });
            return result;
        }

        // faction over time chart on home page
        function drawFactionChart(data, factions, elementid, options) {

            // calculate colors
            var color = [];
            $.each(factions, function (index, faction) {
                switch (options) {
                    case "top":
                        color.push({color: factionCodeToColor(faction)});
                        break;
                    case "all":
                        color.push({color: factionCodeToColor(faction), lineDashStyle: [4, 4]});
                        break;
                    default:
                        color.push({color: factionCodeToColor(faction)},
                                {color: factionCodeToColor(faction), lineDashStyle: [4, 4]});
                }
            });

            var chartOptions = {
                'height': 350,
                'curveType': 'function',
                'vAxis': { format:'#,#%', viewWindowMode: 'explicit', viewWindow: { min: 0 } },
                'hAxis': { showTextEvery: 1, slantedText: 'true' },
                'chartArea': { top: 10, bottom: 10, height: '70%' },
                'legend': { position: 'right', maxLines: 6 },
                'series': color,
                'lineWidth': 3
            };

            var chart = new google.visualization.LineChart(document.getElementById(elementid));
            // hide lines
            var view = new google.visualization.DataView(data);
            switch (options) {
                case "top":
                    view.hideColumns([2,4,6,8,10,12]);
                    break;
                case "all":
                    view.hideColumns([1,3,5,7,9,11]);
                    break;
            }

            chart.draw(view, chartOptions);
            $('#'+elementid).removeClass('spinner');
        }

        /*]]>*/
    </script>
    <div th:replace="fragments/analytics :: ga"></div>
</body>
</html>